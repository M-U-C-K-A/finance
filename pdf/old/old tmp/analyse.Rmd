---
title: "Analyse Financi√®re Avanc√©e du CAC 40"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(tidyquant)
library(DT)
library(scales)
library(lubridate)
```

## üì• Donn√©es du CAC 40

```{r data}
tickers <- c("AI.PA", "AIR.PA", "ALO.PA", "MT.AS", "CS.PA", "BNP.PA", "EN.PA", "CAP.PA",
             "CA.PA", "ACA.PA", "BN.PA", "DSY.PA", "ENGI.PA", "EL.PA", "RMS.PA", "KER.PA",
             "OR.PA", "LR.PA", "MC.PA", "ML.PA", "ORA.PA", "RI.PA", "PUB.PA", "UG.PA",
             "GLE.PA", "SAN.PA", "SU.PA", "SW.PA", "STLA.PA", "STM.PA", "TEC.PA", "HO.PA",
             "TTE.PA", "URW.AS", "VIE.PA", "DG.PA", "VIV.PA", "FR.PA", "WLN.PA", "X.PA")

prices <- tq_get(tickers, from = Sys.Date() - 5, to = Sys.Date()) %>%
  group_by(symbol) %>%
  filter(date == max(date)) %>%
  select(symbol, date, close)
```

## ‚öôÔ∏è Fonctions de valorisation

```{r functions}
bs_call <- function(S, K, r, T, sigma) {
  d1 <- (log(S / K) + (r + 0.5 * sigma^2) * T) / (sigma * sqrt(T))
  d2 <- d1 - sigma * sqrt(T)
  price <- S * pnorm(d1) - K * exp(-r * T) * pnorm(d2)
  delta <- pnorm(d1)
  list(price = price, delta = delta)
}

calc_valuations <- function(S, K, r, T, sigma, eps, revenue, growth = 0.05, wacc = 0.08, g_terminal = 0.02) {
  bs <- bs_call(S, K, r, T, sigma)

  # Graham ajust√©
  graham_raw <- eps * (8.5 + 2 * (growth * 100))
  graham <- min(graham_raw, S * 5)  # Plafond √† 5√ó le prix actuel

  fcf <- 0.1 * revenue
  dcf <- {
    future_fcfs <- sapply(1:5, function(i) fcf * (1 + growth)^i / (1 + wacc)^i)
    terminal <- (fcf * (1 + growth)^5) * (1 + g_terminal) / (wacc - g_terminal)
    terminal_discounted <- terminal / (1 + wacc)^6
    sum(future_fcfs) + terminal_discounted
  }

  tibble(
    BS_Price = bs$price,
    Delta = bs$delta,
    Graham = graham,
    DCF = dcf
  )
}
```

## üîç Calculs + scores

```{r compute}
set.seed(123)
r <- 0.02
sigma <- 0.25
T <- 1
K_factor <- 1.05
g <- 0.05
wacc <- 0.08
g_terminal <- 0.02

valuation_data <- prices %>%
  rowwise() %>%
  mutate(
    Strike = close * K_factor,
    EPS = runif(1, 2, 8),
    Revenue = runif(1, 1e9, 5e10),
    Growth = g
  ) %>%
  mutate(data = list(calc_valuations(close, Strike, r, T, sigma, EPS, Revenue, Growth, wacc, g_terminal))) %>%
  unnest(data) %>%
  mutate(
    Gap_BS = (BS_Price - close) / close * 100,
    Gap_Graham = (Graham - close) / close * 100,
    Gap_DCF = (DCF - close) / close * 100,
    Undervaluation_Score = rowMeans(across(c(Gap_BS, Gap_Graham, Gap_DCF)), na.rm = TRUE)
  )
```

## üìä Tableau final interactif

```{r table}
datatable(
  valuation_data %>%
    select(symbol, close, BS_Price, Graham, DCF, Delta, Gap_BS, Gap_Graham, Gap_DCF, Undervaluation_Score) %>%
    mutate(across(where(is.numeric), round, 2)),
  options = list(pageLength = 15),
  caption = "Comparaison des valorisations vs. cours actuel"
)
```

## üìà Graphiques d‚Äô√©cart de valorisation s√©par√©s

```{r plot_bs}
valuation_data %>%
  ggplot(aes(x = reorder(symbol, Gap_BS), y = Gap_BS)) +
  geom_col(fill = "#0073C2FF") +
  coord_flip() +
  labs(title = "√âcart (%) entre prix Black-Scholes et prix r√©el",
       x = "Entreprise", y = "√âcart (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal()
```

```{r plot_graham}
valuation_data %>%
  ggplot(aes(x = reorder(symbol, Gap_Graham), y = Gap_Graham)) +
  geom_col(fill = "#EFC000FF") +
  coord_flip() +
  labs(title = "√âcart (%) entre valeur Graham et prix r√©el",
       x = "Entreprise", y = "√âcart (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal()
```

```{r plot_dcf}
valuation_data %>%
  ggplot(aes(x = reorder(symbol, Gap_DCF), y = Gap_DCF)) +
  geom_col(fill = "#868686FF") +
  coord_flip() +
  labs(title = "√âcart (%) entre valeur DCF et prix r√©el",
       x = "Entreprise", y = "√âcart (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal()
```

## üìä Histogramme du score d'√©cart moyen

```{r hist_score}
valuation_data %>%
  ggplot(aes(x = Undervaluation_Score)) +
  geom_histogram(bins = 25, fill = "#00A087FF", color = "white") +
  labs(title = "Distribution des scores d'√©cart moyens", x = "Score (%)", y = "Fr√©quence") +
  theme_minimal()
```

## üß≠ Scatter plot : prix r√©el vs score de sous-√©valuation

```{r scatter}
valuation_data %>%
  ggplot(aes(x = close, y = Undervaluation_Score, label = symbol)) +
  geom_point(color = "#3C5488FF", size = 3, alpha = 0.8) +
  geom_text(check_overlap = TRUE, size = 3, vjust = -1) +
  labs(title = "Score de sous-√©valuation vs Prix r√©el",
       x = "Prix de l'action (‚Ç¨)", y = "Score (%)") +
  theme_minimal()
```

## üèÜ Top 10 entreprises sous-√©valu√©es

```{r top}
valuation_data %>%
  select(symbol, close, Undervaluation_Score) %>%
  arrange(desc(Undervaluation_Score)) %>%
  head(10) %>%
  knitr::kable(caption = "Top 10 entreprises sous-√©valu√©es (selon les 3 mod√®les)")
```

## üíæ Export CSV

```{r export}
write_csv(valuation_data, "valuation_cac40_complet.csv")
```

------------------------------------------------------------------------

Si tu veux, je peux aussi t‚Äôaider √† g√©n√©rer un graphique combin√© avec √©chelle secondaire pour DCF (ex : DCF √† droite, BS & Graham √† gauche) ‚Äî mais c‚Äôest plus complexe et souvent moins lisible.

------------------------------------------------------------------------

Dis-moi si tu souhaites que je te pr√©pare √ßa ou si tu veux d‚Äôautres analyses !
