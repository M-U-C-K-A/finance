---
title: "Évaluation Financière de l'Action"
output: html_document
params:
  config_file: "input.json"
---

```{r setup, include=FALSE}
library(jsonlite)
library(quantmod)
library(tidyquant)
library(tidyverse)
library(PerformanceAnalytics)
library(ggplot2)
library(RQuantLib)
library(Quandl)

`%||%` <- function(a, b) if (!is.null(a)) a else b

# Charger la configuration
config <- fromJSON(params$config_file)

# Ticker requis
ticker <- config$ticker
if (is.null(ticker) || ticker == "") {
  stop("Le ticker de l'action doit être spécifié dans le fichier JSON.")
}

# Télécharger les données
getSymbols(ticker, src = "yahoo", auto.assign = TRUE)
data <- get(ticker)
```

---

#### 3. DCF – Discounted Cash Flow

```{r DCF, eval=config$DCF}
cash_flows <- config$cash_flows %||% c(8, 9, 10, 11, 12)
discount_rate <- config$discount_rate %||% 0.08

npv <- sum(cash_flows / (1 + discount_rate)^(1:length(cash_flows)))
cat("Valeur actuelle nette (DCF) :", round(npv, 2), "milliards $")
```

---

#### 4. CAPM

```{r CAPM, eval=config$CAPM}
risk_free_rate <- config$risk_free_rate %||% 0.02
market_return <- config$market_return %||% 0.08
beta <- config$beta %||% 1.2

expected_return <- risk_free_rate + beta * (market_return - risk_free_rate)
cat("Rendement attendu selon le CAPM :", round(expected_return * 100, 2), "%")
```

---

#### 5. Simulation Monte Carlo

```{r MonteCarlo, eval=config$MonteCarlo}
set.seed(123)
S0 <- as.numeric(last(Cl(data)))
mu <- config$mu %||% 0.08
sigma <- config$sigma %||% 0.25
T <- config$T %||% 1
N <- config$N %||% 252
M <- config$M %||% 1000

dt <- T / N
S <- matrix(0, nrow = N + 1, ncol = M)
S[1, ] <- S0

for (j in 1:M) {
  for (i in 2:(N + 1)) {
    S[i, j] <- S[i - 1, j] * exp((mu - 0.5 * sigma^2) * dt + sigma * sqrt(dt) * rnorm(1))
  }
}

matplot(S, type = 'l', col = rgb(0, 0, 1, alpha = 0.1), lty = 1, main = "Simulation Monte Carlo")
```

---

#### 6. Modèle de Graham

```{r Graham, eval=config$Graham}
EPS <- config$EPS %||% 6
growth_rate <- config$growth_rate %||% 10

V <- EPS * (8.5 + 2 * growth_rate)
cat("Valeur selon le modèle de Graham :", round(V, 2), "$")
```

---

#### 7. Black-Scholes

```{r BlackScholes, eval=config$BlackScholes}
S <- as.numeric(last(Cl(data)))
K <- S * 1.05
r <- config$risk_free_rate %||% 0.02
t <- config$T %||% 1
sigma <- config$sigma %||% 0.25

bs <- EuropeanOption("call", underlying = S, strike = K, dividendYield = 0,
                     riskFreeRate = r, maturity = t, volatility = sigma)
cat("Prix de l'option Call (Black-Scholes) :", round(bs$value, 2), "$")
```

---

#### 8. Analyse Technique Avancée

```{r TechAnalysis, eval=config$TechAnalysis}
chartSeries(data, TA = "addMACD(); addRSI()", theme = chartTheme("white"))
```
